name: Publish on GitHub & Modrinth

on:
  workflow_dispatch:
    inputs:
      java-version: {}
      mod-version: {}
      minecraft-version: {}
      minecraft-target-version: {}

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Check out project sources
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/

      - name: Get Gradle properties
        id: get-gradle-properties
        uses: ./.github/actions/read-gradle-properties/action.yml
        with:
          keys: java_version, mod_version, minecraft_version, minecraft_target_version

      - name: Resolve environment variables
        run: |
          echo "${{ needs.get-gradle-properties.outputs.entries }}" >> $GITHUB_ENV
          if [ -n "${{ inputs.java-version }}" ]; then \
            echo "JAVA_VERSION='${{ inputs.java-version }}'" >> $GITHUB_ENV; \
          fi
          if [ -n "${{ inputs.mod-version }}" ]; then \
            echo "JAVA_VERSION='${{ inputs.java-version }}'" >> $GITHUB_ENV; \
          fi
          if [ -n "${{ inputs.minecraft-version }}" ]; then \
            echo "MINECRAFT_VERSION='${{ inputs.minecraft-version }}'" >> $GITHUB_ENV; \
          fi
          if [ -n "${{ inputs.minecraft-target-version }}" ]; then \
            echo "MINECRAFT_TARGET_VERSION='${{ inputs.minecraft-target-version }}'" >> $GITHUB_ENV; \
          fi
        shell: bash

      - name: Build Gradle project
        uses: ./.github/workflows/build.yml

      - name: Publish project
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          name: v${{ env.MOD_VERSION }} for Minecraft ${{ env.MC_VERSION }}
          version: ${{ env.MOD_VERSION }}+${{ env.MC_VERSION }}
          version-type: release

          java: ${{ env.JAVA_VERSION }}
          game-versions: ${{ env.MC_TARGET_VERSION }}
          loaders: fabric

          github-generate-changelog: true
          github-tag: v${{ env.MOD_VERSION }}+${{ env.MC_VERSION }}
          github-token: ${{ secrets.PUBLISH_GITHUB_TOKEN }}

          modrinth-id: ${{ env.MODRINTH_ID }}
          modrinth-featured: true
          modrinth-token: ${{ secrets.PUBLISH_MODRINTH_TOKEN }}
